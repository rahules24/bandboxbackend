# WhatsApp Integration Architecture

## Message Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     INCOMING MESSAGE FLOW                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Customer sends WhatsApp message
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   Customer   â”‚ "Hi, I need help with my order"
   â”‚  ğŸ“± Mobile   â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  WhatsApp Cloud  â”‚ (Meta's infrastructure)
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ POST /api/whatsapp/webhook/
          â”‚ {
          â”‚   "object": "whatsapp_business_account",
          â”‚   "entry": [{
          â”‚     "changes": [{
          â”‚       "value": {
          â”‚         "messages": [{
          â”‚           "from": "919876543210",
          â”‚           "type": "text",
          â”‚           "text": {"body": "Hi, I need help..."}
          â”‚         }]
          â”‚       }
          â”‚     }]
          â”‚   }]
          â”‚ }
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚         Your Django Backend (Fly.io/Railway)            â”‚
   â”‚                                                           â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
   â”‚  â”‚  whatsapp/views.py                               â”‚    â”‚
   â”‚  â”‚  WhatsAppWebhookView                             â”‚    â”‚
   â”‚  â”‚                                                   â”‚    â”‚
   â”‚  â”‚  1. Verify signature âœ“                           â”‚    â”‚
   â”‚  â”‚  2. Parse webhook payload                        â”‚    â”‚
   â”‚  â”‚  3. Extract message data                         â”‚    â”‚
   â”‚  â”‚  4. Save to database â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚    â”‚
   â”‚  â”‚  5. Update conversation            â”‚             â”‚    â”‚
   â”‚  â”‚  6. Download media (if any)        â”‚             â”‚    â”‚
   â”‚  â”‚  7. Send auto-reply (optional)     â”‚             â”‚    â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
   â”‚                                       â”‚                   â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   â”‚  â”‚  PostgreSQL Database                              â”‚   â”‚
   â”‚  â”‚                                                    â”‚   â”‚
   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
   â”‚  â”‚  â”‚  whatsapp_whatsappmessage               â”‚     â”‚   â”‚
   â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚     â”‚   â”‚
   â”‚  â”‚  â”‚  â€¢ message_id: "wamid.ABC123..."        â”‚     â”‚   â”‚
   â”‚  â”‚  â”‚  â€¢ from_number: "919876543210"          â”‚     â”‚   â”‚
   â”‚  â”‚  â”‚  â€¢ from_name: "John Doe"                â”‚     â”‚   â”‚
   â”‚  â”‚  â”‚  â€¢ text_body: "Hi, I need help..."      â”‚     â”‚   â”‚
   â”‚  â”‚  â”‚  â€¢ message_type: "text"                 â”‚     â”‚   â”‚
   â”‚  â”‚  â”‚  â€¢ timestamp: 2024-01-15 10:30:00       â”‚     â”‚   â”‚
   â”‚  â”‚  â”‚  â€¢ status: "received"                   â”‚     â”‚   â”‚
   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
   â”‚  â”‚                                                    â”‚   â”‚
   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
   â”‚  â”‚  â”‚  whatsapp_whatsappconversation          â”‚     â”‚   â”‚
   â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚     â”‚   â”‚
   â”‚  â”‚  â”‚  â€¢ phone_number: "919876543210"         â”‚     â”‚   â”‚
   â”‚  â”‚  â”‚  â€¢ contact_name: "John Doe"             â”‚     â”‚   â”‚
   â”‚  â”‚  â”‚  â€¢ message_count: 15                    â”‚     â”‚   â”‚
   â”‚  â”‚  â”‚  â€¢ unread_count: 3                      â”‚     â”‚   â”‚
   â”‚  â”‚  â”‚  â€¢ last_message_at: 2024-01-15 10:30:00 â”‚     â”‚   â”‚
   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ View messages via:
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚               â”‚               â”‚
          â–¼               â–¼               â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Django  â”‚    â”‚   REST   â”‚   â”‚ Database â”‚
   â”‚  Admin   â”‚    â”‚   API    â”‚   â”‚  Direct  â”‚
   â”‚  Panel   â”‚    â”‚          â”‚   â”‚          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     OUTGOING MESSAGE FLOW                        â”‚
â”‚                     (Your existing setup)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Your Backend (Contact form)
          â”‚
          â”‚ POST https://graph.facebook.com/v21.0/{phone_id}/messages
          â”‚ Authorization: Bearer {token}
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  WhatsApp Cloud  â”‚
   â”‚       API        â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   Customer   â”‚ Receives message
   â”‚  ğŸ“± Mobile   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ Status updates sent back to your webhook:
          â”‚ â€¢ sent
          â”‚ â€¢ delivered
          â”‚ â€¢ read
          â–¼
   Saved in: whatsapp_whatsappmessagestatus
```

## API Endpoints

```
POST   /api/whatsapp/webhook/        â† Facebook posts messages here
GET    /api/whatsapp/webhook/        â† Webhook verification (one-time)
GET    /api/whatsapp/messages/       â† View all messages
GET    /api/whatsapp/conversations/  â† View conversations
POST   /api/whatsapp/mark-read/      â† Mark messages as read
```

## Where to View Messages

### 1. Django Admin (Best for human viewing)
```
https://your-app.fly.dev/admin/whatsapp/whatsappmessage/

Features:
âœ“ Search by phone/name
âœ“ Filter by date/type
âœ“ View full message details
âœ“ See media files
âœ“ Read/edit notes
```

### 2. REST API (Best for programmatic access)
```javascript
// Fetch messages
const messages = await fetch('/api/whatsapp/messages/')
  .then(r => r.json());

// Filter by phone
const customerMessages = await fetch(
  '/api/whatsapp/messages/?phone=919876543210'
).then(r => r.json());
```

### 3. Database Query (Best for analytics)
```sql
SELECT 
  from_number,
  COUNT(*) as msg_count,
  MAX(timestamp) as last_message
FROM whatsapp_whatsappmessage
GROUP BY from_number
ORDER BY last_message DESC;
```

## Call Handling

```
âŒ WABA API does NOT support calls

Customer tries to call
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  WhatsApp shows: â”‚
   â”‚  "This business  â”‚
   â”‚  account can't   â”‚
   â”‚  receive calls"  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SOLUTIONS:

1. Display alternative phone number in business profile
2. Send auto-reply with call instructions
3. Use separate number for calls
4. Add click-to-call button on website
```

## Message Types Handled

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Type         â”‚ What's Stored                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ text         â”‚ text_body                           â”‚
â”‚ image        â”‚ media_id, media_url, caption        â”‚
â”‚ video        â”‚ media_id, media_url                 â”‚
â”‚ audio        â”‚ media_id                            â”‚
â”‚ document     â”‚ media_id, media_url                 â”‚
â”‚ location     â”‚ latitude, longitude, name, address  â”‚
â”‚ interactive  â”‚ text_body (button/list selection)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Security Flow

```
Facebook sends webhook request
          â”‚
          â”‚ Includes header: X-Hub-Signature-256
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Your backend verifies signature:    â”‚
   â”‚                                      â”‚
   â”‚  Expected = HMAC-SHA256(             â”‚
   â”‚    key: WHATSAPP_APP_SECRET,         â”‚
   â”‚    message: request.body             â”‚
   â”‚  )                                   â”‚
   â”‚                                      â”‚
   â”‚  if signature == expected:           â”‚
   â”‚    âœ… Process request                â”‚
   â”‚  else:                               â”‚
   â”‚    âŒ Reject (403 Forbidden)         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Development vs Production

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Development     â”‚  Production                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  localhost:8000  â”‚  your-app.fly.dev                  â”‚
â”‚  + ngrok tunnel  â”‚  Direct HTTPS                      â”‚
â”‚                  â”‚                                    â”‚
â”‚  Webhook URL:    â”‚  Webhook URL:                      â”‚
â”‚  https://        â”‚  https://your-app.fly.dev/         â”‚
â”‚  abc123.ngrok.io â”‚  api/whatsapp/webhook/             â”‚
â”‚  /api/whatsapp/  â”‚                                    â”‚
â”‚  webhook/        â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
